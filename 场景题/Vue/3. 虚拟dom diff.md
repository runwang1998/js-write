# 虚拟 DOM
## 虚拟 DOM 的定义:  
（1）虚拟 DOM 是一个轻量级的 JavaScript 对象，它对真实 DOM 进行了抽象和模拟。  
（2）它是一个树形结构，每个节点对应真实 DOM 中的一个节点。
## 为什么需要虚拟 DOM:
1.  提高性能  
由于直接操作真实DOM需要频繁地进行重排和重绘，而虚拟DOM可以批量更新差异，减少了对真实DOM的操作次数，从而提高了页面渲染效率。
2.  简化开发  
通过使用虚拟DOM，开发者可以将关注点从手动操作真实DOM转移到更高层次的逻辑上。开发者只需要关注页面的结构和状态，而不需要关心具体的DOM操作细节，从而简化了开发流程。
3.  跨平台支持  
由于虚拟DOM是一个独立于平台的JavaScript对象，因此可以在不同的平台上使用。这意味着开发者可以使用相同的代码库来构建Web、移动和桌面应用程序。

## Vue 虚拟 DOM 的工作原理
（1）创建虚拟 DOM：
- 当 Vue 组件被渲染时，Vue 会将模板编译为虚拟 DOM 树。  
- **过程：模版（template）-> 抽象语法树（AST）-> 渲染函数字符串 —> 渲染函数**  
- 虚拟 DOM 是一个 JavaScript 对象，它包含了节点的类型、属性、子节点等信息。 

（2）更新虚拟 DOM：  
- 当组件的数据发生变化时，Vue 会重新渲染模板，生成一个新的虚拟 DOM 树。  
- Vue 会比较新旧虚拟 DOM 树的差异，这个过程称为 **Diff** 算法。  

（3）应用差异到真实 DOM：  
- 通过 Diff 算法计算出的差异，Vue 会生成一个最小化的操作列表。（距离编辑算法）
- Vue 会根据这个操作列表，批量更新真实 DOM，从而减少对 DOM 的操作次数。  

# Diff算法

Vue 的 Diff 算法用于比较新旧虚拟 DOM 树的差异，从而确定需要对真实 DOM 进行哪些操作。其核心步骤如下：
1. 树级比较：从根节点开始，判断新旧树的根节点标签是否相同。若不同，直接替换整棵子树。
2. 节点级比较：若标签相同，则对比节点属性和子节点列表。
- （1）属性变更：检查属性值是否修改，仅更新变化项。
- （2）子节点处理：
    - 若子节点为文本，则直接替换文本内容。
    - 若子节点为标签列表，则通过双端比较（双端优先队列）的方式来优先对比位置相同的节点，以此减少移动操作。

# Vue 3 对虚拟 DOM 的优化

1. **静态提升**  
Vue 3 的编译器具备静态节点识别能力，可自动将模板中不受数据驱动影响的节点（如固定文本、静态布局标签）提升为常量。这些静态节点仅在组件初始化时构建一次虚拟 DOM，后续更新时直接复用，完全跳过 Diff 对比流程。

2. **补丁标志**（Patch Flag）  
Vue 3 为每个虚拟节点都引入了一种二进制编码的标志系统，叫做 Patch Flag。它能精准地标记出这个虚拟节点的哪些属性是动态的。

- 采用二进制编码，是因为这样可以通过位运算高效地组合和判断多种动态属性的情况。

3. **事件缓存机制**  
 Vue 3 对内联事件处理进行了优化，采用了缓存策略。

 - 内联事件是指在模板中通过 @ 指令直接绑定事件处理函数的方式。如<button @click="handleClick"> 中的，@click 。

 - 当组件多次渲染时，如果事件处理函数的逻辑没有发生改变，比如 handleClick 函数的具体实现没有修改，Vue 3 就不会重新创建新的函数实例。相反，它会直接复用首次渲染时缓存下来的事件处理函数。



 